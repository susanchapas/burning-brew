<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout — Burning Brew</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="assets/favicon-01.svg">
  <link rel="stylesheet" href="css/styles.css">
  <script defer src="js/scripts.js"></script>
  <script defer src="js/cart.js"></script>
  <meta name="description" content="Complete your extraction and fuel your next mission." />
</head>
<body class="page-checkout">
  <header class="site-header">
    <div class="nav-inner">
  <a class="brand" href="index.html">
  <img src="assets/svg-trans-logo-icon-01-bone.svg" class="brand-logo" alt="Burning Brew logo" />
    <span class="brand-text">BURNING BREW</span>
  </a>
  <button id="nav-toggle" class="nav-toggle" aria-label="Open navigation" aria-expanded="false">☰</button>
      <nav class="site-nav" id="site-nav" aria-label="Main navigation">
        <a href="products.html">Products</a>
        <a href="vision.html">Vision</a>
        <a href="contact.html">Contact</a>
        <button id="cart-icon" class="cart-btn" aria-label="View shopping cart" aria-haspopup="true" aria-expanded="false">
          <img src="assets/shopping-cart.svg" alt="Shopping cart" />
        </button>
      </nav>
  <div id="cart-dropdown" class="cart-dropdown" aria-live="polite" aria-hidden="true"></div>
    </div>
  </header>

  <main class="checkout-pit" id="main">
    <div class="mobile-drill" aria-hidden="true"><div class="fill" id="mobileFill"></div></div>

    <section class="extraction-level" aria-labelledby="extractionLabel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="extractionLabel" class="extraction-label">EXTRACTION LEVEL</div>
          <div class="subhead">Track the drill — progress your extraction.</div>
        </div>
        <div aria-hidden="true" style="font-weight:700;color:var(--hazard)">Stage 1 of 3</div>
      </div>
      <div class="gauge" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="20" aria-label="Extraction progress">
        <div class="oil" id="gaugeOil" style="width:20%"></div>
      </div>
      <div class="sr-live" aria-live="polite" id="liveRegion"></div>
    </section>

    <div class="two-col">
      <section class="panel feed-the-machine" aria-labelledby="formTitle">
        <h1 id="formTitle" class="page-title animate-descend">FEED THE MACHINE</h1>
        <p class="subhead">Complete your extraction and fuel your next mission.</p>

        <form id="checkoutForm" novalidate>
          <div class="field">
            <label for="fullName">Full Name</label>
            <input id="fullName" name="fullName" type="text" placeholder="Who survives the grind?" required aria-describedby="fullNameError">
            <div id="fullNameError" class="error" aria-live="assertive"></div>
          </div>

          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="We'll send your tracking info here." required aria-describedby="emailError">
            <div id="emailError" class="error" aria-live="assertive"></div>
          </div>

          <div class="field">
            <label for="address">Shipping Address</label>
            <textarea id="address" name="address" placeholder="Mark your territory." required aria-describedby="addressError"></textarea>
            <div id="addressError" class="error" aria-live="assertive"></div>
          </div>

          <div class="field">
            <fieldset class="product-grid" aria-describedby="productError">
              <legend>Select Products</legend>
              <div class="product-option" data-product="single-origin">
                <label class="product-label">
                  <input type="checkbox" class="product-toggle" data-product="single-origin" checked>
                  <span class="product-name">Single Origin — 1 Bag</span>
                  <span class="product-price">$18.00</span>
                </label>
                <input type="number" min="1" value="1" class="product-qty" data-product="single-origin" aria-label="Quantity for Single Origin" />
              </div>
              <div class="product-option disabled" data-product="dark-roast">
                <label class="product-label">
                  <input type="checkbox" class="product-toggle" data-product="dark-roast">
                  <span class="product-name">Dark Roast — 1 Bag</span>
                  <span class="product-price">$18.00</span>
                </label>
                <input type="number" min="1" value="1" class="product-qty" data-product="dark-roast" aria-label="Quantity for Dark Roast" disabled />
              </div>
              <div class="product-option disabled" data-product="blend">
                <label class="product-label">
                  <input type="checkbox" class="product-toggle" data-product="blend">
                  <span class="product-name">The Blend — 1 Bag</span>
                  <span class="product-price">$16.00</span>
                </label>
                <input type="number" min="1" value="1" class="product-qty" data-product="blend" aria-label="Quantity for The Blend" disabled />
              </div>
            </fieldset>
            <div id="productError" class="error" aria-live="assertive"></div>
          </div>

          <div class="field" style="display:flex;gap:.5rem;align-items:center">
            <fieldset style="flex:1;border:0;padding:0;margin:0">
              <legend style="font-weight:700">Delivery</legend>
              <label><input type="radio" name="delivery" value="standard" checked> Standard Burn (3–5 days)</label><br>
              <label><input type="radio" name="delivery" value="rush"> Rush Ignition (1–2 days)</label>
            </fieldset>
          </div>

          <div class="field">
            <label><input id="subscribe" type="checkbox" name="subscribe"> Subscribe to the Source (Monthly Rations)</label>
          </div>

          <div style="display:flex;gap:.6rem;align-items:center;margin-top:1rem">
            <button class="ignite-btn" type="button" id="toPayment">Ignite Purchase</button>
            <div style="margin-left:auto;color:rgba(240,233,214,0.6);font-size:.95rem">Total: <strong id="totalPrice">$0.00</strong></div>
          </div>
        </form>
      </section>

      <aside class="panel fuel-load" aria-labelledby="summaryTitle">
        <h2 id="summaryTitle" style="font-family:Anton,impact;color:var(--accent);">YOUR FUEL LOAD</h2>
        <div id="itemsList" aria-live="polite"></div>
        <div class="fuel-item totals"><strong>Total</strong><strong id="summaryTotal">$0.00</strong></div>
        <div style="margin-top:1rem">
          <button class="ignite-btn" id="scrollToPayment">Refine & Pay</button>
        </div>
      </aside>
    </div>

    <section class="panel refining-energy" id="paymentSection" style="margin-top:1rem" aria-labelledby="paymentTitle">
      <h2 id="paymentTitle" style="font-family:Anton,impact;color:var(--accent);">REFINING YOUR ENERGY</h2>
      <form id="paymentForm" novalidate>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
          <div class="field"><label for="cardNumber">Card Number</label><input id="cardNumber" name="cardNumber" type="text" inputmode="numeric" placeholder="•••• •••• •••• ••••" autocomplete="cc-number" required aria-describedby="cardError"></div>
          <div class="field"><label for="exp">Expiration</label><input id="exp" name="exp" type="text" placeholder="MM/YY" required aria-describedby="expError"></div>
        </div>
        <div style="display:flex;gap:.6rem;align-items:center;margin-top:.6rem">
          <div style="flex:1" class="field"><label for="cvv">CVV</label><input id="cvv" name="cvv" type="text" inputmode="numeric" placeholder="123" required aria-describedby="cvvError"></div>
          <div style="flex:1;align-self:end"><label><input type="checkbox" id="savePayment"> Save payment details for next extraction</label></div>
        </div>

        <div id="paymentError" class="error" aria-live="assertive"></div>
        <div style="margin-top:1rem">
          <button class="ignite-btn" id="igniteTransaction" type="button">Ignite Transaction</button>
        </div>
      </form>
    </section>

  <footer class="site-footer">
    <div class="caution-stripe"></div>
    <div class="footer-inner container">
      <div class="col">
        <div class="logo">
          <img class="footer-logo" src="assets/svg-trans-logo-icon-01-bone.svg" alt="Burning Brew" />
          <span>BURNING BREW</span>
        </div>
        <p class="tagline">From the Earth to the Grind.</p>
      </div>
      <div class="col">
        <div class="contributors">
          <a class="github-link" href="https://github.com/susanchapas" aria-label="Susan Chapas on GitHub" target="_blank" rel="noopener">
            <!-- GitHub mark (inline SVG) -->
            <svg viewBox="0 0 16 16" width="20" height="20" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
            <span class="gh-name">Susan Chapas</span>
          </a>
          <a class="github-link" href="https://github.com/mcbridgeee" aria-label="Bridget McTiernan on GitHub" target="_blank" rel="noopener">
            <svg viewBox="0 0 16 16" width="20" height="20" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
            <span class="gh-name">Bridget McTiernan</span>
          </a>
        </div>
      </div>
      <div class="col">
        <h3 class="section-title">Join the Fossil Order</h3>
        <p class="muted">Receive dispatches from the Grind Frontier.</p>
        <form class="newsletter" action="#" onsubmit="event.preventDefault(); alert('Subscribed — welcome to the Fossil Order.');">
          <label for="newsletter-email" class="sr-only">Your email</label>
          <div class="newsletter-row">
            <input id="newsletter-email" type="email" placeholder="Your email" required />
            <button class="btn small crude-button join-order" type="submit">Subscribe</button>
          </div>
        </form>
      </div>
    </div>
    <div class="bottom-bar">© 2025 Burning Brew. Powered by Prehistoric Decay.</div>
  </footer>
  </main>

  <div class="modal" id="confirmationModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-card" role="document">
      <h2 id="modalTitle" style="font-family:Anton,impact;color:var(--hazard)">You’ve Joined the Fossil Order.</h2>
      <p style="margin-top:1rem;color:var(--bone)">A confirmation has been sent to your coordinates. The excavation continues.</p>
      <button class="surface-btn" id="returnSurface">Return to the Surface</button>
    </div>
  </div>

  <script>
    // Minimal behavior: product autofill, progress updates, validation, modal focus trap
    (function(){
      const params = new URLSearchParams(location.search);
      const productParamRaw = params.get('product');

      const gauge = document.getElementById('gaugeOil');
      const live = document.getElementById('liveRegion');
      const mobileFill = document.getElementById('mobileFill');

      function setStage(n){
        const pct = n===1?20:(n===2?60:100);
        gauge.style.width = pct + '%';
        gauge.parentElement.setAttribute('aria-valuenow', pct);
        live.textContent = 'Extraction progress: stage '+n+' of 3';
        if(mobileFill) mobileFill.style.background = 'conic-gradient(var(--accent) 0% '+pct+'%, rgba(255,255,255,0.02) '+pct+'% 100%)';
      }
      setStage(1);

  // Header solid on scroll — select the site header element used across pages
  const header = document.querySelector('.site-header');
  window.addEventListener('scroll', ()=>{ if(!header) return; if(window.scrollY>10) header.classList.add('solid'); else header.classList.remove('solid'); });

      // Simple form validation
      const checkoutForm = document.getElementById('checkoutForm');
      const paymentForm = document.getElementById('paymentForm');
      const toPayment = document.getElementById('toPayment');
      const scrollToPayment = document.getElementById('scrollToPayment');

      function showError(el, msg){ el.classList.add('invalid'); const err = document.getElementById(el.id+'Error'); if(err) err.textContent = msg; el.setAttribute('aria-invalid','true'); }
      function clearError(el){ el.classList.remove('invalid'); const err = document.getElementById(el.id+'Error'); if(err) err.textContent = ''; el.removeAttribute('aria-invalid'); }

      const productFieldset = document.querySelector('.product-grid');
      const productError = document.getElementById('productError');
      let productToggles = [];
      function clearProductSelectionError(){
        if(productError) productError.textContent='';
        if(productFieldset) productFieldset.removeAttribute('aria-invalid');
      }
      function validateCheckout(){
        let ok=true;
        [['fullName','Please tell the machine who you are.'],['email','Please provide a valid email.'],['address','The machine needs this info.']].forEach(([id,msg])=>{
          const el=document.getElementById(id);
          if(!el.value || (id==='email' && !/\S+@\S+\.\S+/.test(el.value))){ showError(el,msg); ok=false } else clearError(el);
        });
        if(!productToggles.some(t=>t.checked)){
          if(productError) productError.textContent = 'Please choose at least one product.';
          if(productFieldset) productFieldset.setAttribute('aria-invalid','true');
          ok=false;
        } else {
          clearProductSelectionError();
        }
        return ok;
      }

      toPayment.addEventListener('click', ()=>{
        if(!validateCheckout()) return; // stay on form
        // move to payment
        setStage(2);
        document.getElementById('paymentSection').scrollIntoView({behavior:'smooth'});
      });
      scrollToPayment.addEventListener('click', ()=>{ document.getElementById('paymentSection').scrollIntoView({behavior:'smooth'}); setStage(2); });

      // Payment handling (simulation)
      const igniteBtn = document.getElementById('igniteTransaction');
      const modal = document.getElementById('confirmationModal');
      const modalReturn = document.getElementById('returnSurface');

      function validatePayment(){
        let ok=true;
        [['cardNumber','Enter a valid card number.'],['exp','Enter expiration (MM/YY).'],['cvv','Enter CVV.']].forEach(([id,msg])=>{
          const el=document.getElementById(id);
          if(!el.value){ showError(el,msg); ok=false } else clearError(el);
        });
        return ok;
      }

      igniteBtn.addEventListener('click', ()=>{
        if(!validatePayment()) return;
        igniteBtn.disabled=true; igniteBtn.textContent='Processing...';
        setStage(3);
        // small simulated animation delay
        setTimeout(()=>{
          openModal(); igniteBtn.disabled=false; igniteBtn.textContent='Ignite Transaction';
        },900);
      });

      // Modal
      function trapFocus(modalEl){
        const focusable = modalEl.querySelectorAll('a[href], button:not([disabled]), textarea, input, select');
        if(focusable.length===0) return ()=>{};
        let first = focusable[0], last = focusable[focusable.length-1];
        function key(e){ if(e.key==='Tab'){ if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); } else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); } } if(e.key==='Escape'){ closeModal(); } }
        document.addEventListener('keydown', key);
        return ()=>document.removeEventListener('keydown', key);
      }

      let releaseTrap = ()=>{};
      function openModal(){ modal.setAttribute('aria-hidden','false'); modal.style.display='flex'; const prev = document.activeElement; releaseTrap = trapFocus(modal); modal.focus(); modalReturn.focus(); document.body.style.overflow='hidden'; }
      function closeModal(){ modal.setAttribute('aria-hidden','true'); modal.style.display='none'; releaseTrap(); document.body.style.overflow=''; }

      modalReturn.addEventListener('click', ()=>{ closeModal(); window.location.href='index.html'; });
      modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); });

      // Accessibility: announce stage on load
      setTimeout(()=>{ live.textContent='Stage 1: Info Extraction.' },400);

      const itemsList = document.getElementById('itemsList');
      const totalPrice = document.getElementById('totalPrice');
      const summaryTotal = document.getElementById('summaryTotal');
      const productOptions = Array.from(document.querySelectorAll('.product-option'));
      productToggles = Array.from(document.querySelectorAll('.product-toggle'));
      const productQtyInputs = new Map();
      const productData = {
        'single-origin': { name: 'Single Origin — 1 Bag', price: 18 },
        'dark-roast': { name: 'Dark Roast — 1 Bag', price: 18 },
        'blend': { name: 'The Blend — 1 Bag', price: 16 }
      };

      productOptions.forEach(option=>{
        const key = option.dataset.product;
        const qty = option.querySelector('.product-qty');
        if(key && qty){
          productQtyInputs.set(key, qty);
        }
      });

      function ensureMin(input){ if(Number(input.value) < 1) input.value = 1; }

      function syncOptionState(toggle){
        const key = toggle.dataset.product;
        const option = toggle.closest('.product-option');
        const qty = productQtyInputs.get(key);
        const checked = toggle.checked;
        if(option) option.classList.toggle('disabled', !checked);
        if(qty){
          qty.disabled = !checked;
          if(checked && (!qty.value || Number(qty.value) < 1)) qty.value = 1;
        }
      }

      function selectedProducts(){
        return productToggles.filter(t=>t.checked).map(toggle=>{
          const key = toggle.dataset.product;
          const info = productData[key];
          if(!info) return null;
          const qty = Number(productQtyInputs.get(key)?.value) || 1;
          return { key, qty, name: info.name, price: info.price };
        }).filter(Boolean);
      }

      function shippingOf(){
        const selected = document.querySelector('input[name="delivery"]:checked');
        if(!selected) return 0;
        return selected.value === 'rush' ? 8 : 4;
      }

      function formatCurrency(value){ return '$' + value.toFixed(2); }

      function updateTotals(){
        const items = selectedProducts();
        let subtotal = 0;
        const rows = [];
        items.forEach(item=>{
          const lineTotal = item.price * item.qty;
          subtotal += lineTotal;
          const plural = item.qty > 1 ? 'bags' : 'bag';
          rows.push(`<div class="fuel-item"><span>${item.name} — ${item.qty} ${plural}</span><span>${formatCurrency(lineTotal)}</span></div>`);
        });
        if(items.length){
          rows.push(`<div class="fuel-item totals"><span>Subtotal</span><span>${formatCurrency(subtotal)}</span></div>`);
        } else {
          rows.push('<div class="fuel-item"><span>No products selected</span><span>$0.00</span></div>');
        }
        const hasItems = subtotal > 0;
        const ship = hasItems ? shippingOf() : 0;
        const tax = hasItems ? +(subtotal * 0.068).toFixed(2) : 0;
        const total = subtotal + ship + tax;
        rows.push(`<div class="fuel-item"><span>Shipping</span><span>${formatCurrency(ship)}</span></div>`);
        rows.push(`<div class="fuel-item"><span>Tax</span><span>${formatCurrency(tax)}</span></div>`);
        itemsList.innerHTML = rows.join('');
        totalPrice.textContent = formatCurrency(total);
        summaryTotal.textContent = formatCurrency(total);
      }

      const productParamMap = { dark: 'dark-roast', espresso: 'blend' };
      const productParam = productParamMap[productParamRaw] || productParamRaw;

      productToggles.forEach(toggle=>{
        const key = toggle.dataset.product;
        syncOptionState(toggle);
        toggle.addEventListener('change', ()=>{
          syncOptionState(toggle);
          if(productToggles.some(t=>t.checked)) clearProductSelectionError();
          updateTotals();
        });
        const qty = productQtyInputs.get(key);
        if(qty){
          qty.addEventListener('input', ()=>{ ensureMin(qty); updateTotals(); });
        }
      });

      if(productParam && productQtyInputs.has(productParam)){
        productToggles.forEach(toggle=>{
          const isMatch = toggle.dataset.product === productParam;
          toggle.checked = isMatch;
          syncOptionState(toggle);
        });
      }

      document.querySelectorAll('input[name="delivery"]').forEach(r=>r.addEventListener('change', updateTotals));
      updateTotals();

      // ensure forms are keyboard-friendly: Enter on payment triggers ignite
      paymentForm.addEventListener('submit',(e)=>{ e.preventDefault(); igniteBtn.click(); });

      // Expose open/close functions to global for debugging
      window.checkout = { openModal, closeModal };
    })();
  </script>
</body>
</html>
